@page "/home"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JSRuntime

<PageTitle>Museek | Home</PageTitle>

<!-- Search Bar -->
<section class="search-section">
    <div class="search-bar">
        <img src="images/search.png" alt="Search" class="search-icon" />
        <input type="text" @bind="searchQuery" @onkeyup="@HandleSearch" placeholder="Search songs, artists, or albums..." />
    </div>
</section>

<!-- Page Grid -->
<div class="page-grid">
    <!-- Left Side (Content) -->
    <main class="left-content">
        <section class="music-section">
            <h2>Popular Songs</h2>
            <div class="music-grid">
                @foreach (var song in popularSongs)
                {
                    <div class="music-card" @onclick="@(() => PlaySong(song))">
                        <img src="@song.Image" alt="@song.Title">
                        <h4>@song.Title</h4>
                        <p>@song.Artist</p>
                    </div>
                }
            </div>
        </section>

        <section class="music-section">
            <h2>Trending Artists</h2>
            <div class="artist-grid">
                @foreach (var artist in trendingArtists)
                {
                    <div class="artist-card">
                        <img src="@artist.Image" alt="@artist.Name">
                        <h4>@artist.Name</h4>
                    </div>
                }
            </div>
        </section>

        <section class="music-section">
            <h2>New Releases</h2>
            <div class="music-grid">
                @foreach (var release in newReleases)
                {
                    <div class="music-card" @onclick="@(() => PlaySong(release))">
                        <img src="@release.Image" alt="@release.Title">
                        <h4>@release.Title</h4>
                        <p>@release.Artist</p>
                    </div>
                }
            </div>
        </section>
    </main>

    <!-- Right Side (Video and Player) -->
    <aside class="right-content">
        <!-- Random Video Section -->
        <section class="video-box">
            <div class="video-frame">
                <video autoplay muted loop playsinline>
                    <source src="videos/sunflower.mp4" type="video/mp4">
                    <source src="videos/sunflower.webm" type="video/webm">
                    Your browser does not support the video tag.
                </video>
            </div>
        </section>

        <!-- Music Player Section -->
        <section class="player-box">
            <div class="player-left">
                <img id="songCover" src="@currentSong.Image" alt="Cover" />
                <div class="song-info">
                    <h4 id="songTitle">@currentSong.Title</h4>
                    <p id="songArtist">@currentSong.Artist</p>
                </div>
                <img src="@(isLiked ? "images/heartAfter.png" : "images/heartBefore.png")"
                     alt="like"
                     class="icon-btn"
                     @onclick="@ToggleLike" />
            </div>

            <div class="player-controls">
                <input type="range" id="progressBar" min="0" max="100" value="@progress" @oninput="@SeekAudio" />
                <div class="control-buttons">
                    <img src="images/shuffleButton.png" alt="Shuffle" class="control-icon" @onclick="@ToggleShuffle" />
                    <img src="images/prevButton.png" alt="Previous" class="control-icon" @onclick="@PreviousSong" />
                    <img src="@(isPlaying ? "images/pauseButton.png" : "images/playButton.png")"
                         id="playPause"
                         alt="Play"
                         class="control-icon main"
                         @onclick="@TogglePlayPause" />
                    <img src="images/nextButton.png" alt="Next" class="control-icon" @onclick="@NextSong" />
                    <img src="images/repeatButton.png" alt="Repeat" class="control-icon" @onclick="@ToggleRepeat" />
                </div>
                <div class="time-display">
                    <span id="currentTime">@currentTime</span>
                    <span id="remainingTime">-@remainingTime</span>
                </div>
            </div>

            <div class="volume-control">
                <img src="images/volume.png" alt="Volume" class="control-icon" />
                <input type="range" id="volumeBar" min="0" max="100" value="@volume" @oninput="@ChangeVolume" />
            </div>

            <!-- Hidden audio element -->
            <audio id="audioPlayer" src="@GetEncodedAudioPath(currentSong.AudioPath)"></audio>

        </section>
    </aside>
</div>

@code {
    private string searchQuery = "";
    private bool isPlaying = false;
    private bool isLiked = false;
    private double progress = 0;
    private double volume = 70;
    private string currentTime = "00:00";
    private string remainingTime = "00:00";

    // Sample data
    private List<Song> popularSongs = new()
    {
        new Song { Title="About You", Artist="The 1975", Image="images/AboutYou.png", AudioPath="audios/about_you.mp3" },

        new Song { Title = "We Can't Be Friends", Artist = "Ariana Grande", Image = "images/ariana.png", AudioPath = "audios/ariana_friends.mp3" },
        new Song { Title = "Baby", Artist = "Justin Bieber", Image = "images/baby.png", AudioPath = "audios/baby.mp3" },
        //new Song { Title = "Blue", Artist = "Yung Kai", Image = "images/blue.png", AudioPath = "audios/blue.mp3" }
    };

    private List<Artist> trendingArtists = new()
    {
        new Artist { Name = "The Weekend", Image = "images/The Weekend.png" },
        new Artist { Name = "Lana Del Rey", Image = "images/Lana Del Rey.png" },
        new Artist { Name = "Billie Eilish", Image = "images/Billie Eilish.png" }
    };

    private List<Song> newReleases = new()
    {
        new Song { Title = "Dusk Till Dawn", Artist = "ZAYN", Image = "images/Dusk Till Dawn.png", AudioPath = "audios/Dusk Till Dawn.mp3" },
        new Song { Title = "Robbers", Artist = "The 1975", Image = "images/Robbers.png", AudioPath = "audios/Robbers.mp3" },
        new Song { Title = "Give Me Your Forever", Artist = "Zack Tabudlo", Image = "images/GMYF.png", AudioPath = "audios/Give Me Your Forever.mp3" }
    };

    private Song currentSong = new Song
    {
        Title = "",
        Artist = "",
        Image = "",
        AudioPath = ""   // must be empty!
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initializeAudioPlayer");
        }
    }

    private async Task TogglePlayPause()
    {
        isPlaying = !isPlaying;
        await JSRuntime.InvokeVoidAsync("togglePlayPause");
    }

    private void ToggleLike()
    {
        isLiked = !isLiked;
    }

    private async Task PlaySong(Song song)
    {
        currentSong = song;
        isPlaying = true;

        StateHasChanged();

        await Task.Delay(50);

        await JSRuntime.InvokeVoidAsync("initializeAudioPlayer");

        var encodedPath = GetEncodedAudioPath(song.AudioPath);

        await JSRuntime.InvokeVoidAsync("loadAudio", encodedPath);

        await JSRuntime.InvokeVoidAsync("togglePlayPause");
    }

    private async Task PreviousSong()
    {
        await JSRuntime.InvokeVoidAsync("previousSong");
    }

    private async Task NextSong()
    {
        await JSRuntime.InvokeVoidAsync("nextSong");
    }

    private async Task SeekAudio(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out double value))
        {
            progress = value;
            await JSRuntime.InvokeVoidAsync("seekAudio", value);
        }
    }

    private async Task ChangeVolume(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out double value))
        {
            volume = value;
            await JSRuntime.InvokeVoidAsync("changeVolume", value / 100);
        }
    }

    private void ToggleShuffle()
    {
        // Implement shuffle logic
    }

    private void ToggleRepeat()
    {
        // Implement repeat logic
    }

    private void HandleSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Console.WriteLine($"Searching for: {searchQuery}");
        }
    }

    private static string GetEncodedAudioPath(string path)
    {
        if (string.IsNullOrWhiteSpace(path))
            return "";

        var parts = path.Split('/', StringSplitOptions.RemoveEmptyEntries);

        // Encode each segment so spaces, apostrophes, parentheses, etc. work in URLs
        var encodedParts = parts.Select(p => Uri.EscapeDataString(p));

        return string.Join("/", encodedParts);
    }

    // Models
    public class Song
    {
        public string Title { get; set; } = "";
        public string Artist { get; set; } = "";
        public string Image { get; set; } = "";
        public string AudioPath { get; set; } = "";
    }

    public class Artist
    {
        public string Name { get; set; } = "";
        public string Image { get; set; } = "";
    }
}
