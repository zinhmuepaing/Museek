@page "/playlists/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Museek.Domain
@using Museek.Data
@using Microsoft.AspNetCore.Components.Forms
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Edit Playlist</PageTitle>

@if (Playlist == null)
{
    <div class="form-page">
        <p><em>Loading...</em></p>
    </div>
}
else
{
    <div class="form-page">
        <h1 class="page-title">Edit Playlist</h1>

        <EditForm Model="Playlist" OnValidSubmit="UpdatePlaylist">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="field">
                <label>Name</label>
                <InputText class="input" @bind-Value="Playlist.Name" />
            </div>

            <div class="field">
                <label>Description</label>
                <InputText class="input" @bind-Value="Playlist.Description" />
            </div>

            <div class="field">
                <label>Cover Image</label>

                <div class="cover-row">
                    <img class="cover-preview"
                         src="@CoverPreviewSrc"
                         alt="Cover preview" />

                    <div class="cover-actions">
                        <InputFile OnChange="OnCoverSelected" accept="image/*" />
                        <div class="hint">PNG, JPG, WEBP. Max 5 MB.</div>

                        @if (!string.IsNullOrWhiteSpace(uploadError))
                        {
                            <div class="error">@uploadError</div>
                        }
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="primary" type="submit">Save</button>
                <a class="secondary" href="@($"/playlists/details?id={Playlist.Id}")">Cancel</a>
            </div>
        </EditForm>
    </div>
}

@code {
    private MuseekContext context = default!;
    private string currentUserId = string.Empty;

    [SupplyParameterFromQuery] private int Id { get; set; }
    [SupplyParameterFromForm] private Playlist? Playlist { get; set; }

    private IBrowserFile? selectedCoverFile;
    private string? coverDataUrl;
    private string uploadError = "";

    private string CoverPreviewSrc =>
        !string.IsNullOrWhiteSpace(coverDataUrl) ? coverDataUrl :
        !string.IsNullOrWhiteSpace(Playlist?.Cover_Image) ? Playlist!.Cover_Image! :
        "images/default-cover.jpg";

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        currentUserId =
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("userId")?.Value
            ?? string.Empty;

        if (string.IsNullOrWhiteSpace(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        Playlist ??= await context.Playlist.FirstOrDefaultAsync(p => p.Id == Id);
        if (Playlist == null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var isAdmin = user.IsInRole("Administrator");
        var canEdit = isAdmin || Playlist.UserId == currentUserId;
        if (!canEdit)
        {
            NavigationManager.NavigateTo("/userlibrary");
            return;
        }
    }

    private async Task OnCoverSelected(InputFileChangeEventArgs e)
    {
        uploadError = "";
        selectedCoverFile = null;
        coverDataUrl = null;

        if (Playlist == null)
            return;

        var file = e.File;
        if (file == null)
            return;

        const long maxBytes = 5 * 1024 * 1024;

        if (!file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            uploadError = "Please choose an image file.";
            return;
        }

        if (file.Size > maxBytes)
        {
            uploadError = "Image is too large. Max 5 MB.";
            return;
        }

        selectedCoverFile = file;

        // Preview immediately (data URL)
        using var stream = file.OpenReadStream(maxAllowedSize: maxBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());
        coverDataUrl = $"data:{file.ContentType};base64,{base64}";
    }

    private async Task UpdatePlaylist()
    {
        if (Playlist == null)
            return;

        using var db = DbFactory.CreateDbContext();

        // If a new cover is selected, save into wwwroot/images/playlists and store path in Cover_Image.
        if (selectedCoverFile != null)
        {
            var savedPath = await SaveCoverToWwwRootAsync(selectedCoverFile);
            if (!string.IsNullOrWhiteSpace(savedPath))
            {
                Playlist.Cover_Image = savedPath;
            }
        }

        Playlist.DateUpdated = DateTime.Now;
        Playlist.UpdatedBy = currentUserId;

        db.Attach(Playlist).State = EntityState.Modified;
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo($"/playlists/details?id={Playlist.Id}");
    }

    private static async Task<string> SaveCoverToWwwRootAsync(IBrowserFile file)
    {
        // Writes to: wwwroot/images/playlists/<guid>.<ext>
        // Stores relative URL: images/playlists/<guid>.<ext>
        var ext = Path.GetExtension(file.Name);
        if (string.IsNullOrWhiteSpace(ext))
            ext = ".png";

        var safeExt = ext.ToLowerInvariant();
        var allowed = new HashSet<string> { ".png", ".jpg", ".jpeg", ".webp" };
        if (!allowed.Contains(safeExt))
            safeExt = ".png";

        var fileName = $"{Guid.NewGuid():N}{safeExt}";
        var folder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "images", "playlists");
        Directory.CreateDirectory(folder);

        var absolutePath = Path.Combine(folder, fileName);

        const long maxBytes = 5 * 1024 * 1024;
        using var stream = file.OpenReadStream(maxAllowedSize: maxBytes);
        using var fs = File.Create(absolutePath);
        await stream.CopyToAsync(fs);

        return $"images/playlists/{fileName}";
    }
}
