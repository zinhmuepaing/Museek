// FILE: Pages/Playlists/Create.razor
@page "/playlists/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<IdentityUser> UserManager
@attribute [Authorize]

<PageTitle>Create Playlist</PageTitle>

<div class="form-page">
    <h1 class="page-title">New Playlist</h1>

    <EditForm Model="Playlist" OnValidSubmit="AddPlaylist">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="field">
            <label>Name</label>
            <InputText class="input" @bind-Value="Playlist.Name" />
        </div>

        <div class="field">
            <label>Description</label>
            <InputText class="input" @bind-Value="Playlist.Description" />
        </div>

        <div class="field">
            <label>Cover Image (optional)</label>
            <InputText class="input" @bind-Value="Playlist.Cover_Image" />
        </div>

        <div class="actions">
            <button class="primary" type="submit">Create</button>
            <a class="secondary" href="/library">Cancel</a>
        </div>
    </EditForm>
</div>

@code {
    private MuseekContext context = default!;
    private string currentUserId = string.Empty;

    private Playlist Playlist { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        currentUserId =
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("userId")?.Value
            ?? string.Empty;

        if (string.IsNullOrWhiteSpace(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }
    }

    private async Task AddPlaylist()
    {
        using var db = DbFactory.CreateDbContext();

        Playlist.UserId = currentUserId;
        Playlist.CreatedBy = currentUserId;
        Playlist.UpdatedBy = currentUserId;
        Playlist.DateCreated = DateTime.Now;
        Playlist.DateUpdated = DateTime.Now;

        db.Playlist.Add(Playlist);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo("/library");
    }
}
