@page "/playlists"
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@inject IDbContextFactory<Museek.Data.MuseekContext> DbFactory
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@rendermode InteractiveServer

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="playlists/create">Create New</a>
</p>

@if (playlists == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <QuickGrid Class="table" Items="FilteredPlaylists" Pagination="paginationState">
        <PropertyColumn Property="playlist => playlist.Name" Sortable="true" />
        <PropertyColumn Property="playlist => playlist.Description" />
        <PropertyColumn Property="playlist => playlist.Cover_Image" />

        <!-- User column -->
        <TemplateColumn Context="playlist" Title="User">
            @GetUserString(playlist.UserId)
        </TemplateColumn>

        <TemplateColumn Context="playlist">
            <a href="@($"playlists/edit?id={playlist.Id}")">Edit</a> |
            <a href="@($"playlists/details?id={playlist.Id}")">Details</a> |
            <a href="@($"playlists/delete?id={playlist.Id}")">Delete</a>
        </TemplateColumn>

    </QuickGrid>

    <Paginator State="paginationState" />
}

@code {

    PaginationState paginationState = new PaginationState { ItemsPerPage = 1 };

    // Identity users replace your old custom User entity
    private List<IdentityUser> IdentityUsers = new();

    private MuseekContext context = default!;
    private string userId = string.Empty;
    private bool isAdmin = false;

    @inject AuthenticationStateProvider authenticationStateProvider
    @inject UserManager<IdentityUser> UserManager

    // Filter playlists by CreatedBy
    private IQueryable<Playlist> FilteredPlaylists => isAdmin
        ? context.Playlist
        : context.Playlist.Where(e => e.CreatedBy == userId);

    private List<Playlist>? playlists;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Correct Identity user ID claim
        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

        isAdmin = user.IsInRole("Administrator");

        using var context = DbFactory.CreateDbContext();
        playlists = await context.Playlist.ToListAsync();

        // Load all Identity users for display
        IdentityUsers = UserManager.Users.ToList();
    }

    // Convert UserId → display string
    private string GetUserString(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId))
            return "Unknown User";

        var user = IdentityUsers.FirstOrDefault(u => u.Id == userId);

        return user == null ? "Unknown User" : user.Email;
    }
}
