@page "/playlists/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Delete Playlist</PageTitle>

@if (playlist == null)
{
    <div class="page">
        <p><em>Loading...</em></p>
    </div>
}
else
{
    <div class="page">
        <h1 class="page-title">Delete Playlist</h1>

        <div class="warning">
            <div class="warning-title">This will permanently delete your playlist.</div>
            <div class="warning-sub">
                Songs will not be deleted, only this playlist and its saved song links.
            </div>
        </div>

        <div class="card">
            <div class="card-top">
                <img class="cover"
                     src="@CoverSrc"
                     alt="Playlist cover" />

                <div class="meta">
                    <div class="name">@playlist.Name</div>
                    @if (!string.IsNullOrWhiteSpace(playlist.Description))
                    {
                        <div class="desc">@playlist.Description</div>
                    }
                    else
                    {
                        <div class="desc muted">No description</div>
                    }

                    <div class="stats">
                        <div class="stat">
                            <div class="stat-num">@songCount</div>
                            <div class="stat-label">songs</div>
                        </div>

                        <div class="stat">
                            <div class="stat-num">@playlist.DateCreated.ToShortDateString()</div>
                            <div class="stat-label">created</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="actions">
                <a class="btn" href="@($"/playlists/details?id={playlist.Id}")">Cancel</a>
                <button class="danger"
                        disabled="@isDeleting"
                        @onclick="DeletePlaylist">
                    @(isDeleting ? "Deleting..." : "Delete Playlist")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private MuseekContext context = default!;
    private string currentUserId = string.Empty;

    [SupplyParameterFromQuery] private int Id { get; set; }

    private Playlist? playlist;
    private int songCount = 0;
    private bool isDeleting = false;

    private string CoverSrc =>
        !string.IsNullOrWhiteSpace(playlist?.Cover_Image)
            ? playlist!.Cover_Image!
            : "images/default-cover.jpg";

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        currentUserId =
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("userId")?.Value
            ?? string.Empty;

        if (string.IsNullOrWhiteSpace(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        playlist = await context.Playlist.FirstOrDefaultAsync(p => p.Id == Id);
        if (playlist == null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var isAdmin = user.IsInRole("Administrator");
        var canDelete = isAdmin || playlist.UserId == currentUserId;
        if (!canDelete)
        {
            NavigationManager.NavigateTo("/userlibrary");
            return;
        }

        songCount = await context.PlaylistSong.CountAsync(ps => ps.PlaylistId == playlist.Id);
    }

    private async Task DeletePlaylist()
    {
        if (playlist == null || isDeleting)
            return;

        isDeleting = true;

        using var db = DbFactory.CreateDbContext();

        var links = await db.PlaylistSong
            .Where(ps => ps.PlaylistId == playlist.Id)
            .ToListAsync();

        if (links.Count > 0)
        {
            db.PlaylistSong.RemoveRange(links);
        }

        db.Playlist.Remove(playlist);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo("/userlibrary");
    }
}
