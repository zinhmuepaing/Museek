@page "/songs/edit"
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<Museek.Data.MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Env

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>
<h2>Song</h2>
<hr />

@if (Song is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4">

            <EditForm method="post" Model="Song" OnValidSubmit="UpdateSong" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary role="alert" />

                <input type="hidden" name="Song.Id" value="@Song.Id" />

                <!-- TITLE -->
                <div class="mb-3">
                    <label class="form-label">Title:</label>
                    <InputText @bind-Value="Song.Title" class="form-control" />
                    <ValidationMessage For="() => Song.Title" class="text-danger" />
                </div>

                <!-- AUDIO FILE SELECT -->
                <div class="mb-3">
                    <label class="form-label">Audio File:</label>
                    <InputSelect @bind-Value="Song.Audio_File" class="form-control">
                        <option value="">-- Select Audio File --</option>
                        @foreach (var file in AudioFiles)
                        {
                            <option value="@($"audios/{file}")">@file</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Song.Audio_File" class="text-danger" />
                </div>

                <!-- DURATION -->
                <div class="mb-3">
                    <label class="form-label">Duration:</label>
                    <InputNumber @bind-Value="Song.Duration" class="form-control" />
                    <ValidationMessage For="() => Song.Duration" class="text-danger" />
                </div>

                <!-- COVER ART SELECT -->
                <div class="mb-3">
                    <label class="form-label">Cover Art:</label>
                    <InputSelect @bind-Value="Song.Cover_Art" class="form-control">
                        <option value="">-- Select Cover Image --</option>
                        @foreach (var img in ImageFiles)
                        {
                            <option value="@($"images/{img}")">@img</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Song.Cover_Art" class="text-danger" />
                </div>

                <!-- ALBUM SELECT -->
                <div class="mb-3">
                    <label class="form-label">Album:</label>
                    <InputSelect @bind-Value="Song.AlbumId" class="form-control">
                        <option value="">-- Select Album --</option>

                        @foreach (var album in Albums)
                        {
                            <option value="@album.Id">@album.Title</option>
                        }

                        <!-- Hardcoded fallback -->
                        <option value="101">Hardcoded Album A</option>
                        <option value="102">Hardcoded Album B</option>
                        <option value="103">Hardcoded Album C</option>
                    </InputSelect>
                    <ValidationMessage For="() => Song.AlbumId" class="text-danger" />
                </div>

                <!-- ARTIST SELECT -->
                <div class="mb-3">
                    <label class="form-label">Artist:</label>
                    <InputSelect @bind-Value="Song.ArtistId" class="form-control">
                        <option value="">-- Select Artist --</option>

                        @foreach (var artist in Artists)
                        {
                            <option value="@artist.Id">@artist.Name</option>
                        }

                        <!-- Hardcoded fallback -->
                        <option value="201">Hardcoded Artist X</option>
                        <option value="202">Hardcoded Artist Y</option>
                        <option value="203">Hardcoded Artist Z</option>
                    </InputSelect>
                    <ValidationMessage For="() => Song.ArtistId" class="text-danger" />
                </div>

                <!-- DATES -->
                <div class="mb-3" hidden>
                    <label class="form-label">DateCreated:</label>
                    <InputDate @bind-Value="Song.DateCreated" class="form-control" />
                    <ValidationMessage For="() => Song.DateCreated" class="text-danger" />
                </div>

                <div class="mb-3" hidden>
                    <label class="form-label">DateUpdated:</label>
                    <InputDate @bind-Value="Song.DateUpdated" class="form-control" />
                    <ValidationMessage For="() => Song.DateUpdated" class="text-danger" />
                </div>

                <!-- CREATEDBY -->
                <div class="mb-3" hidden>
                    <label class="form-label">CreatedBy:</label>
                    <InputText @bind-Value="Song.CreatedBy" class="form-control" />
                    <ValidationMessage For="() => Song.CreatedBy" class="text-danger" />
                </div>

                <!-- UPDATEDBY -->
                <div class="mb-3" hidden>
                    <label class="form-label">UpdatedBy:</label>
                    <InputText @bind-Value="Song.UpdatedBy" class="form-control" />
                    <ValidationMessage For="() => Song.UpdatedBy" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>

        </div>
    </div>
}

<div>
    <a href="/songs">Back to List</a>
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Song? Song { get; set; }

    private List<string> AudioFiles = new();
    private List<string> ImageFiles = new();

    private IList<Album> Albums = new List<Album>();
    private IList<Artist> Artists = new List<Artist>();

    protected override void OnInitialized()
    {
        LoadFileLists();

        using var context = DbFactory.CreateDbContext();
        Albums = context.Album.ToList();
        Artists = context.Artist.ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Song ??= await context.Song.FirstOrDefaultAsync(m => m.Id == Id);

        if (Song is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private void LoadFileLists()
    {
        var audioDir = Path.Combine(Env.WebRootPath, "audios");
        var imageDir = Path.Combine(Env.WebRootPath, "images");

        if (Directory.Exists(audioDir))
            AudioFiles = Directory.GetFiles(audioDir).Select(Path.GetFileName).ToList();

        if (Directory.Exists(imageDir))
            ImageFiles = Directory.GetFiles(imageDir).Select(Path.GetFileName).ToList();
    }

    private async Task UpdateSong()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Song!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!SongExists(Song!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/songs");
    }

    private bool SongExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Song.Any(e => e.Id == id);
    }
}
