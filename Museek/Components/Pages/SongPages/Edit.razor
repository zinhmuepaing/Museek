@page "/songs/edit"
@using Museek.Domain
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<Museek.Data.MuseekContext> DbFactory
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Edit Song</PageTitle>

<div class="upload-container">

    <!-- Header -->
    <div class="header">
        <h2>Edit Song</h2>
    </div>

    @if (song == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="form-card">

            <EditForm Model="song" OnValidSubmit="UpdateSong">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <!-- Song Title -->
                <div class="form-group">
                    <label>Song Title</label>
                    <InputText @bind-Value="song.Title" />
                    <ValidationMessage For="() => song.Title" class="text-danger" />
                </div>

                <!-- Artist Select -->
                <div class="form-group">
                    <label>Artist</label>
                    <InputSelect @bind-Value="song.ArtistId">
                        @foreach (var a in artists)
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => song.ArtistId" class="text-danger" />
                </div>

                <!-- Album Select -->
                <div class="form-group">
                    <label>Album</label>
                    <InputSelect @bind-Value="song.AlbumId">
                        @foreach (var al in albums)
                        {
                            <option value="@al.Id">@al.Title</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => song.AlbumId" class="text-danger" />
                </div>

                <!-- Cover File -->
                <div class="form-group">
                    <label>Replace Cover Image (optional)</label>
                    <InputFile OnChange="OnCoverSelected" />
                </div>

                <!-- Audio File -->
                <div class="form-group">
                    <label>Replace Audio File (optional)</label>
                    <InputFile OnChange="OnAudioSelected" />
                </div>

                <button class="save-btn" type="submit">Save Changes</button>

            </EditForm>
        </div>
    }

</div>

@code {
    [SupplyParameterFromQuery]
    public int Id { get; set; }

    private Song? song;
    private List<Artist> artists = new();
    private List<Album> albums = new();

    private IBrowserFile? newCoverFile;
    private IBrowserFile? newAudioFile;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Load the song by ID
        song = await context.Song.FirstOrDefaultAsync(s => s.Id == Id);

        if (song == null)
        {
            NavigationManager.NavigateTo("/notfound");
            return;
        }

        // Load dropdowns
        artists = await context.Artist.OrderBy(a => a.Name).ToListAsync();
        albums = await context.Album.OrderBy(a => a.Title).ToListAsync();
    }

    private void OnCoverSelected(InputFileChangeEventArgs e)
    {
        newCoverFile = e.File;
        song!.Cover_Art = $"images/{newCoverFile.Name}";
    }

    private void OnAudioSelected(InputFileChangeEventArgs e)
    {
        newAudioFile = e.File;
        song!.Audio_File = $"audios/{newAudioFile.Name}";
    }

    private async Task UpdateSong()
    {
        using var context = DbFactory.CreateDbContext();

        var existing = await context.Song.FirstOrDefaultAsync(s => s.Id == song!.Id);
        if (existing == null)
        {
            NavigationManager.NavigateTo("/notfound");
            return;
        }

        // Update basic metadata
        existing.Title = song.Title;
        existing.ArtistId = song.ArtistId;
        existing.AlbumId = song.AlbumId;
        existing.DateUpdated = DateTime.UtcNow;

        // Replace cover only if user uploads a new one
        if (newCoverFile != null)
            existing.Cover_Art = song.Cover_Art;

        // Replace audio only if user uploads a new one
        if (newAudioFile != null)
            existing.Audio_File = song.Audio_File;

        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/songs");
    }
}
