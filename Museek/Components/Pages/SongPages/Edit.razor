@page "/songs/edit"
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@inject IDbContextFactory<Museek.Data.MuseekContext> DbFactory
@inject NavigationManager Navigation

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Edit Song</PageTitle>

<div class="upload-container">

    <div class="header">
        <h2>Edit Song</h2>
    </div>

    @if (song == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="form-card">

            <div class="form-group">
                <label>Song Title</label>
                <input type="text" @bind="song.Title" />
            </div>

            <div class="form-group">
                <label>Artist</label>
                <select @bind="song.ArtistId">
                    @foreach (var a in artists)
                    {
                        <option value="@a.Id">@a.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Album</label>
                <select @bind="song.AlbumId">
                    @foreach (var al in albums)
                    {
                        <option value="@al.Id">@al.Title</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Replace Cover Image (optional)</label>
                <InputFile OnChange="OnCoverSelected" />
            </div>

            <div class="form-group">
                <label>Replace Audio File (optional)</label>
                <InputFile OnChange="OnAudioSelected" />
            </div>

            <button class="save-btn" @onclick="UpdateSong">Save Changes</button>
        </div>
    }

</div>

@code {
    [SupplyParameterFromQuery]
    public int Id { get; set; }

    private Song? song;

    private List<Artist> artists = new();
    private List<Album> albums = new();

    private IBrowserFile? newCoverFile;
    private IBrowserFile? newAudioFile;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        song = await context.Song.FirstOrDefaultAsync(s => s.Id == Id);

        if (song == null)
        {
            Navigation.NavigateTo("/notfound");
            return;
        }

        artists = await context.Artist.OrderBy(a => a.Name).ToListAsync();
        albums = await context.Album.OrderBy(a => a.Title).ToListAsync();
    }

    private void OnCoverSelected(InputFileChangeEventArgs e)
    {
        newCoverFile = e.File;
    }

    private void OnAudioSelected(InputFileChangeEventArgs e)
    {
        newAudioFile = e.File;
    }

    private async Task UpdateSong()
    {
        using var context = DbFactory.CreateDbContext();

        var existing = await context.Song.FirstOrDefaultAsync(s => s.Id == song!.Id);
        if (existing == null)
        {
            Navigation.NavigateTo("/notfound");
            return;
        }

        // Update main fields
        existing.Title = song.Title;
        existing.ArtistId = song.ArtistId;
        existing.AlbumId = song.AlbumId;
        existing.DateUpdated = DateTime.Now;

        // Replace cover file if selected
        if (newCoverFile != null)
        {
            existing.Cover_Art = newCoverFile.Name;
        }

        // Replace audio file if selected
        if (newAudioFile != null)
        {
            existing.Audio_File = newAudioFile.Name;
        }

        await context.SaveChangesAsync();

        Navigation.NavigateTo("/songs");
    }
}
