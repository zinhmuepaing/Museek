@page "/songs"
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory

<PageTitle>Songs</PageTitle>

<div class="library-container">

    <div class="header">
        <h2>My Library</h2>

        <div class="actions">
            <div class="search-box">
                <img src="images/search.png" class="search-icon" />
                <input type="text" placeholder="Search library" @bind="searchText" />
            </div>

            <a href="songs/create" class="action-btn primary">+ Upload music</a>
            <a href="songs/edit" class="action-btn">Edit Song</a>
            <a href="songs/details" class="action-btn">Details</a>
            <a href="songs/delete" class="action-btn danger">Delete</a>
        </div>
    </div>

    <div class="song-list">
        <table class="song-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Artist</th>
                    <th>Album</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var s in FilteredSongs)
                {
                    <tr>
                        <td class="song-info">
                            <img src="@s.Cover_Art" class="cover-img" />
                            <div class="song-text">
                                <div class="title">@s.Title</div>
                            </div>
                        </td>

                        <td>@GetArtistName(s.ArtistId)</td>
                        <td>@GetAlbumTitle(s.AlbumId)</td>
                        <td>@s.Duration</td>

                        <td>
                            <a href="@($"songs/edit?id={s.Id}")">Edit</a> |
                            <a href="@($"songs/details?id={s.Id}")">Details</a> |
                            <a href="@($"songs/delete?id={s.Id}")">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>

@code {
    private MuseekContext context = default!;
    private List<Song> songs = new();
    private List<Artist> artists = new();
    private List<Album> albums = new();

    private string searchText = "";

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        songs = context.Song.ToList();
        artists = context.Artist.ToList();
        albums = context.Album.ToList();
    }

    private IEnumerable<Song> FilteredSongs =>
        string.IsNullOrWhiteSpace(searchText)
        ? songs
        : songs.Where(s => s.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase));

    private string GetArtistName(int id) =>
        artists.FirstOrDefault(a => a.Id == id)?.Name ?? "Unknown";

    private string GetAlbumTitle(int id) =>
        albums.FirstOrDefault(a => a.Id == id)?.Title ?? "Unknown";
}
